services:
  system-eye:
    build:
      context: .
      dockerfile: Dockerfile.system-eye
    container_name: system-eye
    ports:
      - "8080:8080"
      - "50051:50051"
    networks:
      - system-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, utility, compute]
    volumes:
      - /tmp:/tmp:rw

  system-guardian:
    build:
      context: .
      dockerfile: Dockerfile.system-guardian
    container_name: system-guardian
    depends_on:
      system-eye:
        condition: service_healthy # Wait for eye to be ready
    environment:
      - SYSTEM_EYE_HOST=system-eye
      - SYSTEM_EYE_PORT=50051
    networks:
      - system-net
    pid: "service:system-eye" # Use 'service:' syntax for modern compose
    cap_add:
      - SYS_PTRACE
    volumes:
      - /tmp:/tmp:rw

  system-brain:
    build:
      context: .
      dockerfile: Dockerfile.system-brain
    image: system-brain:latest 
    container_name: system-brain
    depends_on:
      system-eye:
        condition: service_healthy
    ports:
      - "5000:5000"
    networks:
      - system-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, utility, compute]

  chat-server:
    build:
      context: .
      dockerfile: Dockerfile.chat-server
    container_name: chat-server
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY} # Best to pull from host env
      - PORT=3000
    ports:
      - "3000:3000"
    networks:
      - system-net

networks:
  system-net:
    driver: bridge